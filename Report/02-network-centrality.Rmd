# Network analysis

## Operazioni preliminari
```{r message=FALSE, warning=FALSE}
# set working directory
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
# source a set of functions
source("util.R")

# import libraries
libraries_list <- c("ggraph", "igraph", "dplyr", "readr", "DiagrammeR", "tidyverse", "Cairo", "networkD3", "CINNA", "scales")
import_libraries(libraries_list)
```

```{r graph}
# import graph
edges <- read.csv(
  "../dataset/diseasome [Edges].csv",
  head = TRUE
)

nodes <- read.csv(
  "../dataset/diseasome [Nodes].csv",
  head = TRUE
)

nodes <- nodes %>% select(-timeset)
edges <- edges %>% select(-timeset, -label)

graph <- graph.data.frame(edges, directed = TRUE, vertices = nodes)
# print(graph, e=TRUE, v=TRUE) ## IGRAPH 9af20f4 DNW- 1419 3926

ggraph(graph, layout="kk") + #  "graphopt""
    geom_edge_fan(colour = "gray66", show.legend = FALSE) +
    geom_node_point(fill= ifelse(nodes$X0 == "gene", "#FFAB40", "#4182A8"), #"#FFAB40",
                    shape=21, col="grey25", show.legend = FALSE) +
    scale_size_continuous(range=c(1, 10)) +
    theme_graph(base_size = 11, base_family = "sans") +
    ggtitle("Human Disease Network") 
```

```{r}
vcount(graph)
ecount(graph)
```

```{r edge_similarity}
# similarities
ggplot(edges, aes(x = edges$Source, y = edges$Target, color = "red")) + 
  geom_point() + 
  labs(x = "Source") +
  labs(y = "Target") +
  ggtitle("Edges similarity")

# no isolated nodes
```

## Centrality Analitycs

### Degree
```{r degree_histogram}
degree <- centr_degree(graph, mode = "all", normalized = TRUE)

histogram_plot(degree$res, seq(0, 160, by = 20), "degree", "frequency", "Degree histogram")

# nodes with the highest degree
V(graph)$label[order(degree$res, decreasing=TRUE)][1:5]
# "Colon cancer", "Deafness", "Leukemia", "Breast cancer", "Diabetes mellitus"
```

```{r indegree_histogram}
indegree <- centr_degree(graph, mode = "in", normalized = TRUE)

histogram_plot(indegree$res, seq(0, 160, by = 20), "indegree", "frequency", "Indegree histogram")

# node with the highest indegree
V(graph)$label[order(indegree$res, decreasing=TRUE)][1:5]
# "Colon cancer", "Deafness", "Leukemia", "Breast cancer", "Diabetes mellitus"
```

```{r outdegree_histogram}
outdegree <- centr_degree(graph, mode = "out", normalized = TRUE)

histogram_plot(outdegree$res, seq(0, 160, by = 20), "outdegree", "frequency", "Outdegree histogram")

# node with the highest outdegree
V(graph)$label[order(outdegree$res, decreasing=TRUE)][1:5]
# "Colon cancer"      "Deafness"          "Leukemia"          "Breast cancer"    "Diabetes mellitus"
```
Otteniamo sempre gli stessi risultati

### Betweenness

```{r betweennes_histogram}
betweenness <- betweenness(graph, v = V(graph), directed = TRUE, normalized = TRUE)

histogram_plot(betweenness, c(0, 1), "betweenness", "frequency", "Betweenness histogram")

# node with the highest betweenness
V(graph)$label[order(betweenness, decreasing=TRUE)][1:5] 
# "Cardiomyopathy" "Lipodystrophy"     "Diabetes mellitus" "Glioblastoma"      "Deafness" 
```

```{r graph_betweennes}
plot_graph(graph, "dh", betweenness, 0.14, 0.01, 0.0001, nodes$label, 0.14, "Human Disease Network Betweenness Centrality")
```

### Closeness

```{r closeness_histogram}
closeness <- closeness(graph, v = V(graph), normalized = TRUE)

histogram_plot(closeness, c(0, 1), "closeness", "frequency", "Closeness histogram")

# node with the highest closeness
V(graph)$label[order(closeness, decreasing=TRUE)][1:5] 
# "Lipodystrophy"     "Diabetes mellitus" "Glioblastoma"      "Obesity"           "Cardiomyopathy"
```

```{r graph_closeness}
plot_graph(graph, "dh", closeness, 0.23, 0.09, 0.07, nodes$label, 0.23, "Human Disease Network Closeness Centrality")
```

### Pagerank
```{r pagerank_histogram}
pagerank <- page_rank(graph, v = V(graph), directed = TRUE)

histogram_plot(pagerank$vector, c(0, 1), "pagerank", "frequency", "Pagerank histogram")

# node with the highest pagerank
V(graph)$label[order(pagerank$vector, decreasing=TRUE)][1:5] 
# "Colon cancer"      "Deafness"          "Leukemia"          "Diabetes mellitus" "Thyroid carcinoma"
```

```{r graph_pagerank}
plot_graph(graph, "dh", pagerank$vector, 0.003, 0.001, 0.0007, nodes$label, 0.003, "Human Disease Network Pagerank Centrality")
```

### Eigenvector

```{r eigen_histogram}
eigen <- eigen_centrality(graph, directed = TRUE)

histogram_plot(eigen$vector, c(0, 1), "eigen", "frequency", "Eigenvector histogram")

# node with the highest eigen
V(graph)$label[order(eigen$vector, decreasing=TRUE)][1:5] 
# "Colon cancer"      "Breast cancer"     "Thyroid carcinoma" "Pancreatic cancer" "Hepatic adenoma"  
```

```{r graph_eigen}
plot_graph(graph, "dh", eigen$vector, 0.55, 0.04, 0.00005, nodes$label, 0.55, "Human Disease Network Eigenvector Centrality")
```

## Network without genes and weighted

Settiamo il peso di ogni arco pari al numero di geni che condividono le malattie:

```{r}
for (i in 1:length(edges[, 5]))
{
  edge <- edges[i, ]
  
  n1 <- V(graph)[as.character(edge$Source)]
  n2 <- V(graph)[as.character(edge$Target)]
  
  # find the vertices not farther than a given limit from another fixed vertex  
  n1.neigh <- neighborhood(graph, nodes = n1)[[1]]
  n2.neigh <- neighborhood(graph, nodes = n2)[[1]]
  
  n1.neigh <- as.numeric(n1.neigh[n1.neigh$X1 == "gene"])
  n2.neigh <- as.numeric(n2.neigh[n2.neigh$X1 == "gene"])
  
  weight <- length(intersect(n1.neigh, n2.neigh))
  
  edges[i, ]$weight <- weight
}

weighted_graph <- graph.data.frame(edges, directed = FALSE, vertices = nodes)

UD_nogenes <- induced_subgraph(weighted_graph, which(nodes$X1 != "gene"))

# Rimuovo i doppi nodi
UD_nogenes <- igraph::simplify(UD_nogenes)

ggraph(UD_nogenes, layout="graphopt") + #  "graphopt""
  geom_edge_fan(aes(width=E(UD_nogenes)$weight), colour = "gray66", show.legend = FALSE) +
  geom_node_point(fill="#FFAB40", shape=21, 
                  col="grey25", show.legend = FALSE) +
  scale_edge_width_continuous(range=c(0.2,0.9)) +
  scale_size_continuous(range=c(1, 10)) +
  theme_graph(base_size = 11, base_family = "sans") +
  ggtitle("Human Disease Network Nogenes") 
```
```{r}
vcount(UD_nogenes)
ecount(UD_nogenes)
```
## Centrality Analitycs

### Degree
```{r UD_nogenes_degree_histogram}
UD_nogenes_degree <- centr_degree(UD_nogenes, mode = "all", normalized = TRUE)

histogram_plot(UD_nogenes_degree$res, seq(0, 160, by = 20), "degree", "frequency", "Degree histogram (nogenes)")

# nodes with the highest degree
V(graph)$label[order(UD_nogenes_degree$res, decreasing=TRUE)][1:5]
# "Colon cancer", "Breast cancer"     "Gastric cancer"    "Leukemia"  "Thyroid carcinoma"
```


```{r UD_nogenes_degree}
plot_pretty_graph(UD_nogenes, "dh", UD_nogenes_degree$res, E(UD_nogenes)$weight, 25, 15, 8, nodes$label[nodes$X0 == "disease"], 25, "Human Disease Network (nogenes) Degree Centrality")
```
### Betweenness

```{r UD_nogenes_betweennes_histogram}
UD_nogenes_betweenness <- betweenness(UD_nogenes, v = V(UD_nogenes), directed = TRUE, normalized = TRUE, weights=E(UD_nogenes)$weight)

histogram_plot(UD_nogenes_betweenness, c(0, 1), "betweenness", "frequency", "Betweenness histogram (nogenes)")

# nodes with the highest betweenness
V(graph)$label[order(UD_nogenes_betweenness, decreasing=TRUE)][1:5]
# "Cardiomyopathy"    "Lipodystrophy"     "Diabetes mellitus" "Glioblastoma"      "Myopathy"
```

```{r UD_nogenes_UD_nogenes_betweennes}
plot_pretty_graph(UD_nogenes, "dh", UD_nogenes_betweenness, E(UD_nogenes)$weight, 0.3, 0.1, 0.005, nodes$label[nodes$X0 == "disease"], 0.3, "Human Disease Network (nogenes) Betweenness Centrality")
```

### Closeness
```{r UD_nogenes_closeness_histogram}
UD_nogenes_closeness <- closeness(UD_nogenes, v = V(UD_nogenes), normalized = TRUE, weights=E(UD_nogenes)$weight)

histogram_plot(UD_nogenes_closeness, c(0, 1), "closeness", "frequency", "Closeness histogram (nogenes)")

# nodes with the highest closeness
V(graph)$label[order(UD_nogenes_closeness, decreasing=TRUE)][1:5]
# "Diabetes mellitus"  "Lipodystrophy"      "Glioblastoma"       "Cardiomyopathy"    "Insulin resistance"
```

```{r UD_nogenes_closeness}
plot_pretty_graph(UD_nogenes, "dh", UD_nogenes_closeness, E(UD_nogenes)$weight, 0.11, 0.09, 0.07, nodes$label[nodes$X0 == "disease"], 0.11, "Human Disease Network (nogenes) Closeness Centrality")
```

### Pagerank
```{r UD_nogenes_pagerank_histogram}
UD_nogenes_pagerank <- page_rank(UD_nogenes, v = V(UD_nogenes), directed = TRUE, weights=E(UD_nogenes)$weight)

histogram_plot(UD_nogenes_pagerank$vector, c(0, 1), "pagerank", "frequency", "Pagerank histogram (nogenes)")

# nodes with the highest pagerank
V(graph)$label[order(UD_nogenes_pagerank$vector, decreasing=TRUE)][1:5]
# "Colon cancer"      "Deafness"          "Diabetes mellitus" "Breast cancer"     "Leukemia" 
```

```{r UD_nogenes_pagerank}
plot_pretty_graph(UD_nogenes, "dh", UD_nogenes_pagerank$vector, E(UD_nogenes)$weight, 0.01, 0.0025, 0.0008, nodes$label[nodes$X0 == "disease"], 0.01, "Human Disease Network (nogenes) Pagerank Centrality")
```

### Eigenvector
```{r UD_nogenes_eigen_histogram}
UD_nogenes_eigen <- eigen_centrality(UD_nogenes, directed = TRUE, weights=E(UD_nogenes)$weight)

histogram_plot(UD_nogenes_eigen$vector, c(0, 1), "eigen", "frequency", "Eigenvector histogram (nogenes)")

# nodes with the highest eigenvector
V(graph)$label[order(UD_nogenes_eigen$vector, decreasing=TRUE)][1:5]
#"Colon cancer"      "Breast cancer"     "Ovarian cancer"    "Lymphoma"          "Pancreatic cancer"
```

```{r UD_nogenes_eigen}
plot_pretty_graph(UD_nogenes, "dh", UD_nogenes_eigen$vector, E(UD_nogenes)$weight, 0.6, 0.04, 0.001, nodes$label[nodes$X0 == "disease"], 0.6, "Human Disease Network (nogenes) Eigenvector Centrality")
```

#### Dendogramma

```{r}
dendrogram <- as.dendrogram(hclust(dist(graph[,])))
dendrogram_nogenes <- as.dendrogram(hclust(dist(UD_nogenes[,])))

ggraph(dendrogram, 'dendrogram') + 
  geom_edge_diagonal() +
  ggtitle("Human Disease Network dendogram") 

ggraph(dendrogram_nogenes, 'dendrogram') + 
  geom_edge_diagonal() +
  ggtitle("Human Disease Network (nogenes) dendogram") 
```
